'use client';

import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css";
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import { ThemeProvider } from "@/components/theme/ThemeProvider";
import { I18nProvider } from "@/components/i18n/I18nProvider";
import { Sidebar } from "@/components/layout/Sidebar";
import { Navbar } from "@/components/layout/Navbar";
import { ThemeCustomizerPanel } from "@/components/layout/ThemeCustomizerPanel";
import { useTheme } from "@/components/theme/ThemeProvider";
import { useState, useEffect } from "react";
import { usePathname } from "next/navigation";
import clsx from "clsx";
import FeatureUpdateNotification from '@/components/notifications/FeatureUpdateNotification';
import { AuthProvider } from '@/contexts/AuthContext';

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

// Create a stable QueryClient instance
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 1000 * 60 * 5, // 5 minutes
      refetchOnWindowFocus: false,
      retry: 1,
    },
  },
});

// Route to title mapping
const routeTitles: Record<string, string> = {
  '/dashboard': 'Dashboard',
  '/students': 'Students',
  '/tahfiz': 'Tahfiz Overview',
  '/tahfiz/students': 'Tahfiz Students',
  '/tahfiz/records': 'Tahfiz Records',
  '/tahfiz/books': 'Tahfiz Books',
  '/tahfiz/portions': 'Tahfiz Portions',
  '/tahfiz/groups': 'Tahfiz Groups',
  '/tahfiz/attendance': 'Tahfiz Attendance',
  '/tahfiz/plans': 'Learning Plans',
  '/tahfiz/reports': 'Tahfiz Reports',
  // Add more routes as needed...
};

function getPageTitle(pathname: string): string {
  // Check for exact match first
  if (routeTitles[pathname]) {
    return `${routeTitles[pathname]} - DRAIS`;
  }
  
  // Check for partial matches (for dynamic routes)
  const matchingRoute = Object.keys(routeTitles).find(route => 
    pathname.startsWith(route) && route !== '/'
  );
  
  if (matchingRoute) {
    return `${routeTitles[matchingRoute]} - DRAIS`;
  }
  
  // Fallback: convert pathname to title
  const segments = pathname.split('/').filter(Boolean);
  if (segments.length === 0) return 'DRAIS';
  
  const title = segments[segments.length - 1]
    .split('-')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
  
  return `${title} - DRAIS`;
}

function DynamicTitle() {
  const pathname = usePathname();
  
  useEffect(() => {
    const title = getPageTitle(pathname);
    document.title = title;
  }, [pathname]);
  
  return null;
}

function LayoutContent({ children }: { children: React.ReactNode }) {
  const theme = useTheme();
  const pathname = usePathname(); // Get the current route
  const [sidebarOpen, setSidebarOpen] = useState(false);

  // Exclude Sidebar and Navbar for specific routes
  const hideSidebarAndNavbar = pathname === '/academics/reports' || pathname === '/';

  return (
    <div className="min-h-screen">
      <DynamicTitle />
      {!hideSidebarAndNavbar && <Navbar onToggleSidebar={() => setSidebarOpen(!sidebarOpen)} />}
      {!hideSidebarAndNavbar && <Sidebar />}
      <main
        className={clsx(
          "transition-all duration-300",
          hideSidebarAndNavbar ? "pt-0" : "pt-16", // Conditional padding-top
          !hideSidebarAndNavbar && (theme.sidebarCollapsed ? "md:ml-16" : "md:ml-72"),
          hideSidebarAndNavbar && "ml-0" // No margin when Sidebar is hidden
        )}
      >
        {children}
      </main>
      {!hideSidebarAndNavbar && <ThemeCustomizerPanel />}
      <FeatureUpdateNotification />
    </div>
  );
}

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en" suppressHydrationWarning>
      <body className={`${geistSans.variable} ${geistMono.variable} antialiased selection:bg-[var(--color-primary)]/20`}>
        <QueryClientProvider client={queryClient}>
            <ThemeProvider>
              <I18nProvider>
                <LayoutContent>{children}</LayoutContent>
              </I18nProvider>
            </ThemeProvider>
        </QueryClientProvider>
      </body>
    </html>
  );
}

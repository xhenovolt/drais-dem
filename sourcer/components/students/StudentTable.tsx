"use client";
import React, { useState, useEffect } from 'react';
import { QRCodeCanvas } from 'qrcode.react';
import useSWR from 'swr';
import useSWRImmutable from 'swr/immutable';
import { Plus, Search, Loader2, Printer, FileDown, FileUp, Edit, Trash, Eye, MoreVertical, Filter, Users, UserCheck, UserX, UserMinus, Clock, CheckSquare, Square, Camera, Upload, Home, Thermometer, Fingerprint } from 'lucide-react';
import clsx from 'clsx';
import { StudentWizard } from './StudentWizard';
import { EditStudentWizard } from './EditStudentWizard';
import { LearnerDetailsModal } from './LearnerDetailsModal';
import { ImportModal } from './ImportModal';
import { BulkPhotoUploadModal } from './BulkPhotoUploadModal';
import { StatusActionModal } from './StatusActionModal';
import { FingerprintModal } from './FingerprintModal';
import { useI18n } from '@/components/i18n/I18nProvider';
import { useRouter } from 'next/navigation';
import Swal from 'sweetalert2';
import { fetcher } from '@/utils/fetcher';
import jsPDF from 'jspdf';
import autoTable from 'jspdf-autotable';
import { motion, AnimatePresence } from 'framer-motion';
import PhotoEditorModal from './PhotoEditorModal'; // <-- new import
import { toast } from 'react-hot-toast';
import { Info } from 'lucide-react';
import { usePagination } from '@/hooks/usePagination';
import Pagination from '@/components/ui/Pagination';

const API_BASE = '/api';

interface Student {
  id: number;
  admission_no?: string;
  first_name: string;
  last_name: string;
  other_name?: string;
  gender?: string;
  date_of_birth?: string;
  phone?: string;
  email?: string;
  address?: string;
  photo_url?: string;
  // make status optional and extend possible values
  status?: 'active' | 'suspended' | 'on_leave' | 'dropped_out' | 'at_home' | 'sick' | 'expelled';
  admission_date?: string;
  class_id?: string;
  class_name?: string;
  stream_name?: string;
  theology_class_id?: string;
  stream_id?: string;
  academic_year_id?: string;
  term_id?: string;
  notes?: string;
  district_name?: string;
  village_name?: string;
  attendance_percentage?: number;
}

const statusOptions = [
  { value: 'active', label: 'Active', icon: UserCheck, color: 'text-green-600 bg-green-50' },
  { value: 'suspended', label: 'Suspended', icon: UserX, color: 'text-red-600 bg-red-50' },
  { value: 'on_leave', label: 'On Leave', icon: Clock, color: 'text-yellow-600 bg-yellow-50' },
  { value: 'dropped_out', label: 'Dropped Out', icon: UserMinus, color: 'text-gray-600 bg-gray-50' },
  { value: 'at_home', label: 'At Home', icon: Home, color: 'text-blue-600 bg-blue-50' },
  { value: 'sick', label: 'Sick', icon: Thermometer, color: 'text-pink-600 bg-pink-50' },
  { value: 'expelled', label: 'Expelled', icon: UserX, color: 'text-red-800 bg-red-100' },
];

export const StudentTable: React.FC = () => {
  const { t, lang, dir } = useI18n();
  const isRTL = dir === 'rtl';
  
  // Allow upload components to opt-out of client-side file-size limits.
  // Other components (e.g. StudentWizard, BulkPhotoUploadModal) can read:
  // if ((window as any).__ALLOW_LARGE_UPLOADS) { /* skip size checks */ }
  useEffect(() => {
    (window as any).__ALLOW_LARGE_UPLOADS = true;
    return () => {
      try { delete (window as any).__ALLOW_LARGE_UPLOADS; } catch { (window as any).__ALLOW_LARGE_UPLOADS = undefined; }
    };
  }, []);

  
  const [query, setQuery] = useState('');
  const [page, setPage] = useState(1);
  const [open, setOpen] = useState(false);
  const [editOpen, setEditOpen] = useState(false);
  const [detailsOpen, setDetailsOpen] = useState(false);
  const [selectedClass, setSelectedClass] = useState('');
  const [selectedStream, setSelectedStream] = useState('');
  const [selectedGender, setSelectedGender] = useState('');
  const [selectedStatus, setSelectedStatus] = useState('');
  const [selectedStudent, setSelectedStudent] = useState<Student | null>(null);
  const [selectedLearner, setSelectedLearner] = useState<Student | null>(null);
  const [isEditing, setIsEditing] = useState(false);
  const [exportType, setExportType] = useState('csv');
  const [importType, setImportType] = useState('csv');
  const [selectedLearners, setSelectedLearners] = useState<number[]>([]);
  const [bulkClass, setBulkClass] = useState('');
  const [importOpen, setImportOpen] = useState(false);
  const [fingerprintModalOpen, setFingerprintModalOpen] = useState(false);
  const [fingerprintStudent, setFingerprintStudent] = useState<Student | null>(null);
  const [qrCodeUrl, setQrCodeUrl] = useState('');
  const [selectedStudentId, setSelectedStudentId] = useState<number | null>(null);
  const [showFilters, setShowFilters] = useState(false);
  const [showBulkActions, setShowBulkActions] = useState(false);
  const [showBulkPhotoUpload, setShowBulkPhotoUpload] = useState(false);
  const [statusModalOpen, setStatusModalOpen] = useState(false);
  const [statusAction, setStatusAction] = useState<'suspend' | 'expel' | null>(null);
  const [statusTargetStudent, setStatusTargetStudent] = useState<Student | null>(null);
  const [photoEditorOpen, setPhotoEditorOpen] = useState(false);
  const [photoEditorStudent, setPhotoEditorStudent] = useState<Student | null>(null);
  const [fingerprintStatuses, setFingerprintStatuses] = useState<Record<number, {hasFingerprint: boolean, loading: boolean, lastFetched?: number}>>({});
  
  // Inline editing state
  const [editingCell, setEditingCell] = useState<{studentId: number, field: 'first_name' | 'last_name'} | null>(null);
  const [editingValue, setEditingValue] = useState('');
  const [isUpdating, setIsUpdating] = useState(false);
  
  const router = useRouter();

  // Effect to handle clicking outside of editing input
  useEffect(() => {
    if (!editingCell || isUpdating) return;

    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      // Check if the click is on an input or if we're in the middle of an update
      if (!target.closest('input[type="text"]') && !target.closest('.inline-edit-container')) {
        saveInlineEdit();
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, [editingCell?.studentId, editingCell?.field, isUpdating]);

  const { data, isLoading, mutate } = useSWR(
    `${API_BASE}/students/full?q=${encodeURIComponent(query)}${selectedClass ? `&class_id=${selectedClass}` : ''}${selectedStream ? `&stream_id=${selectedStream}` : ''}${selectedGender ? `&gender=${selectedGender}` : ''}${selectedStatus ? `&status=${selectedStatus}` : ''}`,
    fetcher
  );

  const rows: Student[] = data?.data || [];
  const total = rows.length;
  const rowsPerPage = 10;
  const pages = Math.ceil(total / rowsPerPage) || 1;

  const { data: classData } = useSWRImmutable(`${API_BASE}/classes`, fetcher);
  const classOptions = classData?.data || [];

  const { data: streamData } = useSWRImmutable(`${API_BASE}/streams`, fetcher);
  const streamOptions = streamData?.data || [];

  // Helper functions
  const generateAdmissionNo = (id: number) => `XHN/${id.toString().padStart(4, '0')}/2025`;

  // Inline editing functions
  const startInlineEdit = (studentId: number, field: 'first_name' | 'last_name', currentValue: string) => {
    if (isUpdating || editingCell) return; // Prevent editing while update is in progress or another cell is being edited
    setEditingCell({ studentId, field });
    setEditingValue(currentValue);
  };

  const cancelInlineEdit = () => {
    setEditingCell(null);
    setEditingValue('');
  };

  const saveInlineEdit = async () => {
    if (!editingCell || isUpdating) return;
    
    const student = rows.find(s => s.id === editingCell.studentId);
    if (!student) return;

    // Don't save if value hasn't changed
    const currentValue = student[editingCell.field];
    if (editingValue.trim() === currentValue) {
      cancelInlineEdit();
      return;
    }

    // Validate input
    if (!editingValue.trim()) {
      toast.error('Name cannot be empty');
      setEditingValue(currentValue); // Reset to original value
      return;
    }

    setIsUpdating(true);

    try {
      const updateData = {
        id: student.id,
        first_name: editingCell.field === 'first_name' ? editingValue.trim() : student.first_name,
        last_name: editingCell.field === 'last_name' ? editingValue.trim() : student.last_name,
        other_name: student.other_name,
        gender: student.gender,
        date_of_birth: student.date_of_birth,
        phone: student.phone,
        email: student.email,
        address: student.address,
        class_id: student.class_id,
        status: student.status,
        photo_url: student.photo_url
      };

      const response = await fetch('/api/students/edit', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(updateData),
      });

      const result = await response.json();

      if (result.success) {
        // Optimistically update local data
        mutate();
        toast.success(`${editingCell.field === 'first_name' ? 'First name' : 'Last name'} updated successfully`);
        cancelInlineEdit();
      } else {
        throw new Error(result.error || 'Update failed');
      }
    } catch (error: any) {
      console.error('Inline edit error:', error);
      toast.error(`Failed to update ${editingCell.field === 'first_name' ? 'first name' : 'last name'}: ${error.message}`);
      // Reset to original value
      setEditingValue(student[editingCell.field]);
    } finally {
      setIsUpdating(false);
    }
  };

  const handleInlineEditKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      saveInlineEdit();
    } else if (e.key === 'Escape') {
      e.preventDefault();
      cancelInlineEdit();
    }
  };

  const getStatusBadge = (status?: Student['status']) => {
    if (!status) {
      return (
        <span className="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium text-gray-600 bg-gray-50">
          Select status
        </span>
      );
    }
    const statusOption = statusOptions.find(s => s.value === status);
    const Icon = statusOption?.icon || UserCheck;
    
    return (
      <span className={clsx('inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium', statusOption?.color)}>
        <Icon className="w-3 h-3" />
        {statusOption?.label || status}
      </span>
    );
  };

  // Enterprise-grade avatar component with theme-aware fallback
  const getStudentAvatar = (student: Student, size = 'w-10 h-10') => {
    // Check for photo from people table via person_id relationship
    const photoUrl = student.photo_url;
    
    if (photoUrl) {
      return (
        <div className="relative group">
          <img 
            src={photoUrl} 
            alt={`${student.first_name} ${student.last_name}`}
            className={`${size} rounded-full object-cover shadow-md ring-2 ring-white dark:ring-slate-600 transition-all duration-200 group-hover:shadow-lg group-hover:scale-105`}
            onError={(e) => {
              // Enhanced error logging for debugging
              console.warn(`Failed to load image for ${student.first_name} ${student.last_name}:`, photoUrl);
              
              // Graceful fallback to initials on image load error
              const target = e.target as HTMLImageElement;
              const fallback = target.nextElementSibling as HTMLElement;
              target.style.display = 'none';
              if (fallback) fallback.classList.remove('hidden');
            }}
            onLoad={() => {
              // Debug successful loads
              console.log(`Successfully loaded image for ${student.first_name} ${student.last_name}:`, photoUrl);
            }}
          />
          {/* Fallback initials (hidden by default) */}
          <div className={`${size} rounded-full bg-gradient-to-br from-blue-500 to-purple-600 dark:from-blue-600 dark:to-purple-700 flex items-center justify-center shadow-md ring-2 ring-white dark:ring-slate-600 transition-all duration-200 hidden absolute inset-0`}>
            <span className="text-sm font-semibold text-white select-none">
              {student.first_name?.charAt(0)?.toUpperCase()}{student.last_name?.charAt(0)?.toUpperCase()}
            </span>
          </div>
        </div>
      );
    }
    
    // Direct initials fallback with enterprise styling
    return (
      <div className={`${size} rounded-full bg-gradient-to-br from-blue-500 to-purple-600 dark:from-blue-600 dark:to-purple-700 flex items-center justify-center shadow-md ring-2 ring-white dark:ring-slate-600 transition-all duration-200 hover:shadow-lg hover:scale-105`}>
        <span className="text-sm font-semibold text-white select-none">
          {student.first_name?.charAt(0)?.toUpperCase()}{student.last_name?.charAt(0)?.toUpperCase()}
        </span>
      </div>
    );
  };

  // Enhanced avatar for larger displays with improved enterprise styling
  const getStudentAvatarLarge = (student: Student, size = 'w-12 h-12') => {
    const photoUrl = student.photo_url;
    
    if (photoUrl) {
      return (
        <div className="relative group">
          <img 
            src={photoUrl} 
            alt={`${student.first_name} ${student.last_name}`}
            className={`${size} rounded-xl object-cover shadow-lg ring-3 ring-white dark:ring-slate-600 transition-all duration-300 group-hover:shadow-xl group-hover:scale-105 group-hover:ring-blue-200 dark:group-hover:ring-blue-700`}
            onError={(e) => {
              const target = e.target as HTMLImageElement;
              const fallback = target.nextElementSibling as HTMLElement;
              target.style.display = 'none';
              if (fallback) fallback.classList.remove('hidden');
            }}
          />
          {/* Enhanced fallback with enterprise styling */}
          <div className={`${size} rounded-xl bg-gradient-to-br from-blue-500 via-purple-500 to-pink-500 dark:from-blue-600 dark:via-purple-600 dark:to-pink-600 flex items-center justify-center shadow-lg ring-3 ring-white dark:ring-slate-600 transition-all duration-300 hidden absolute inset-0`}>
            <span className="text-lg font-bold text-white select-none tracking-wide">
              {student.first_name?.charAt(0)?.toUpperCase()}{student.last_name?.charAt(0)?.toUpperCase()}
            </span>
          </div>
        </div>
      );
    }
    
    return (
      <div className={`${size} rounded-xl bg-gradient-to-br from-blue-500 via-purple-500 to-pink-500 dark:from-blue-600 dark:via-purple-600 dark:to-pink-600 flex items-center justify-center shadow-lg ring-3 ring-white dark:ring-slate-600 transition-all duration-300 hover:shadow-xl hover:scale-105 hover:ring-blue-200 dark:hover:ring-blue-700`}>
        <span className="text-lg font-bold text-white select-none tracking-wide">
          {student.first_name?.charAt(0)?.toUpperCase()}{student.last_name?.charAt(0)?.toUpperCase()}
        </span>
      </div>
    );
  };

  const clearFilters = () => {
    setQuery('');
    setSelectedClass('');
    setSelectedStream('');
    setSelectedGender('');
    setSelectedStatus('');
    setPage(1);
  };

  // Data processing - single source of truth
  const uniqueRows = rows.filter(
    (student, index, self) => self.findIndex((s) => s.id === student.id) === index
  );
  const paginatedRows = uniqueRows.slice((page - 1) * rowsPerPage, page * rowsPerPage);

  // Event handlers
  const handleEdit = (student: Student) => {
    setSelectedStudent(student);
    setEditOpen(true);
  };

  const handleDelete = async (student: Student) => {
    const confirm = await Swal.fire({
      title: 'Are you sure?',
      text: `You are about to delete ${student.first_name} ${student.last_name}. This action cannot be undone!`,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Yes, delete it!',
      cancelButtonText: 'Cancel',
    });

    if (confirm.isConfirmed) {
      try {
        const response = await fetch(`${API_BASE}/students/delete`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: student.id }),
        });
        const result = await response.json();
        if (result.success) {
          Swal.fire('Deleted!', 'The student has been deleted.', 'success');
          mutate();
        } else {
          Swal.fire('Error!', 'Failed to delete the student.', 'error');
        }
      } catch (error) {
        Swal.fire('Error!', 'An unexpected error occurred.', 'error');
      }
    }
  };

  const handleSubmit = async (formData: Student) => {
    const confirm = await Swal.fire({
      title: 'Confirm Edit',
      text: 'Are you sure you want to save these changes?',
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: 'Yes, save it!',
      cancelButtonText: 'Cancel',
    });

    if (confirm.isConfirmed) {
      try {
        const response = await fetch(`${API_BASE}/students/edit`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData),
        });
        const result = await response.json();
        if (response.ok && result.success) {
          Swal.fire('Saved!', 'The student details have been updated.', 'success');
          setOpen(false);
          mutate();
        } else {
          Swal.fire('Error!', result.error || 'Failed to update the student details.', 'error');
        }
      } catch (error) {
        Swal.fire('Error!', 'An unexpected error occurred.', 'error');
      }
    }
  };

  const handleStatusChange = async (student: Student, newStatus: Student['status']) => {
    const statusOption = statusOptions.find(s => s.value === newStatus);
    
    const confirm = await Swal.fire({
      title: 'Change Student Status',
      html: `
        <div class="text-center">
          <p>Change status of <strong>${student.first_name} ${student.last_name}</strong> to:</p>
          <div class="mt-3 p-3 rounded-lg ${statusOption?.color}">
            <span class="font-semibold">${statusOption?.label}</span>
          </div>
        </div>
      `,
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: 'Yes, change status',
      cancelButtonText: 'Cancel',
      customClass: {
        popup: 'rounded-2xl',
        confirmButton: 'bg-blue-600 hover:bg-blue-700',
        cancelButton: 'bg-gray-300 hover:bg-gray-400'
      }
    });

    if (confirm.isConfirmed) {
      try {
        const response = await fetch(`${API_BASE}/students/status`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ student_id: student.id, new_status: newStatus }),
        });

        const result = await response.json();

        if (result.success) {
          Swal.fire({
            title: 'Status Updated!',
            text: `${student.first_name} ${student.last_name} is now ${statusOption?.label}`,
            icon: 'success',
            timer: 2000,
            showConfirmButton: false
          });
          mutate();
        } else {
          Swal.fire('Error!', result.error || 'Failed to update status.', 'error');
        }
      } catch (error) {
        Swal.fire('Error!', 'An unexpected error occurred.', 'error');
      }
    }
  };

  const handleViewDetails = (student: Student) => {
    setSelectedLearner(student);
    setDetailsOpen(true);
  };

  const openPhotoEditor = (student: Student) => {
    setPhotoEditorStudent(student);
    setPhotoEditorOpen(true);
  };

  // Load fingerprint statuses for visible students with 10-minute cache
  useEffect(() => {
    const loadFingerprintStatuses = async () => {
      const now = Date.now();
      const CACHE_DURATION = 10 * 60 * 1000; // 10 minutes in milliseconds
      
      const studentsToFetch = paginatedRows.filter(student => {
        const status = fingerprintStatuses[student.id];
        
        // Skip if already loading
        if (status?.loading) return false;
        
        // Skip if recently fetched (within 10 minutes)
        if (status?.lastFetched && (now - status.lastFetched) < CACHE_DURATION) return false;
        
        return true;
      });

      if (studentsToFetch.length === 0) return;

      // Set loading state for students we're about to fetch
      const loadingUpdates = studentsToFetch.reduce((acc, student) => {
        acc[student.id] = { 
          hasFingerprint: fingerprintStatuses[student.id]?.hasFingerprint || false, 
          loading: true,
          lastFetched: fingerprintStatuses[student.id]?.lastFetched
        };
        return acc;
      }, {} as Record<number, {hasFingerprint: boolean, loading: boolean, lastFetched?: number}>);

      setFingerprintStatuses(prev => ({ ...prev, ...loadingUpdates }));

      const statusPromises = studentsToFetch.map(async (student) => {
        try {
          const response = await fetch(`/api/students/${student.id}/fingerprint`);
          const result = await response.json();
          
          return {
            studentId: student.id,
            hasFingerprint: result.success && (result.data?.hasPhone || result.data?.hasBiometric),
            error: null
          };
        } catch (error) {
          console.error(`Failed to load fingerprint status for student ${student.id}:`, error);
          return {
            studentId: student.id,
            hasFingerprint: false,
            error: error
          };
        }
      });

      const results = await Promise.all(statusPromises);
      
      // Update all statuses at once
      const statusUpdates = results.reduce((acc, result) => {
        acc[result.studentId] = {
          hasFingerprint: result.hasFingerprint,
          loading: false,
          lastFetched: now
        };
        return acc;
      }, {} as Record<number, {hasFingerprint: boolean, loading: boolean, lastFetched: number}>);

      setFingerprintStatuses(prev => ({ ...prev, ...statusUpdates }));
    };

    if (paginatedRows.length > 0) {
      loadFingerprintStatuses();
    }
  }, [paginatedRows]); // Removed fingerprintStatuses from dependencies to prevent infinite loops

  // Enhanced fingerprint click handler with cache invalidation
  const handleFingerprintClick = (student: Student) => {
    const status = fingerprintStatuses[student.id];
    
    if (status?.hasFingerprint) {
      toast('Fingerprint already registered! Opening management...', {
        duration: 2000,
        position: 'top-right',
        icon: 'âœ…'
      });
    } else {
      toast('Opening fingerprint registration...', {
        duration: 2000,
        position: 'top-right',
        icon: 'ðŸ”’'
      });
    }
    
    setFingerprintStudent(student);
    setFingerprintModalOpen(true);
  };

  // Listen for fingerprint status changes from the modal
  useEffect(() => {
    const handleFingerprintStatusChange = (event: CustomEvent) => {
      const { studentId, hasFingerprint } = event.detail;
      
      // Immediately update the status and mark as recently fetched
      setFingerprintStatuses(prev => ({
        ...prev,
        [studentId]: { 
          hasFingerprint, 
          loading: false,
          lastFetched: Date.now() // Mark as just updated
        }
      }));
    };

    window.addEventListener('fingerprintStatusChanged', handleFingerprintStatusChange as EventListener);
    
    return () => {
      window.removeEventListener('fingerprintStatusChanged', handleFingerprintStatusChange as EventListener);
    };
  }, []);

  // Enhanced fingerprint icon with better loading state
  const getFingerprintIcon = (student: Student) => {
    const status = fingerprintStatuses[student.id];
    
    if (status?.loading) {
      return (
        <Loader2 className="w-4 h-4 animate-spin text-blue-400" />
      );
    }

    if (status?.hasFingerprint) {
      return (
        <Fingerprint className="w-4 h-4 text-green-600" />
      );
    }

    return (
      <Fingerprint className="w-4 h-4 text-gray-400" />
    );
  };

  // Enhanced fingerprint button with status styling
  const getFingerprintButton = (student: Student, isMobile = false) => {
    const status = fingerprintStatuses[student.id];
    const baseClass = isMobile 
      ? "p-2 rounded-lg transition-all"
      : "p-2 rounded-lg transition-all dark:hover:bg-purple-900/20";
    
    if (status?.hasFingerprint) {
      return (
        <button
          onClick={() => handleFingerprintClick(student)}
          className={`${baseClass} ${isMobile ? 'bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-300 hover:bg-green-200 dark:hover:bg-green-900/40' : 'text-green-600 hover:text-green-700 hover:bg-green-50'}`}
          title="Fingerprint Registered - Manage"
        >
          {getFingerprintIcon(student)}
        </button>
      );
    }

    return (
      <button
        onClick={() => handleFingerprintClick(student)}
        className={`${baseClass} ${isMobile ? 'bg-gray-100 dark:bg-slate-600 text-gray-600 dark:text-gray-300 hover:bg-purple-100 hover:text-purple-600' : 'text-gray-400 hover:text-purple-600 hover:bg-purple-50'}`}
        title="Register Fingerprint"
      >
        {getFingerprintIcon(student)}
      </button>
    );
  };

  // Enhanced bulk actions
  const handleSelectLearner = (id: number) => {
    setSelectedLearners((prev) =>
      prev.includes(id) ? prev.filter((learnerId) => learnerId !== id) : [...prev, id]
    );
  };

  const handleSelectAll = () => {
    const allIds = paginatedRows.map((row) => row.id);
    setSelectedLearners((prev) =>
      prev.length === allIds.length ? [] : allIds
    );
  };

  const handleBulkAssign = async () => {
    if (selectedLearners.length === 0) {
      Swal.fire('Error', 'Please select at least one student.', 'error');
      return;
    }

    if (!bulkClass) {
      Swal.fire('Error', 'Please select a class to assign.', 'error');
      return;
    }

    const selectedClassName = classOptions.find((cls: any) => cls.id === parseInt(bulkClass))?.name || 'Unknown Class';

    const confirm = await Swal.fire({
      title: 'Bulk Class Assignment',
      html: `
        <div class="text-center">
          <p>Assign <strong>${selectedLearners.length}</strong> selected students to:</p>
          <div class="mt-3 p-3 rounded-lg bg-blue-50">
            <span class="font-semibold text-blue-800">${selectedClassName}</span>
          </div>
          <p class="mt-3 text-sm text-gray-600">This will update their class enrollment.</p>
        </div>
      `,
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: 'Yes, Assign Class',
      cancelButtonText: 'Cancel',
      customClass: {
        popup: 'rounded-2xl',
        confirmButton: 'bg-blue-600 hover:bg-blue-700',
        cancelButton: 'bg-gray-300 hover:bg-gray-400'
      }
    });

    if (!confirm.isConfirmed) return;

    try {
      Swal.fire({
        title: 'Processing...',
        html: 'Assigning class to selected students...',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        },
      });

      const response = await fetch(`${API_BASE}/students/bulk-assign`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ learnerIds: selectedLearners, classId: bulkClass }),
      });
      
      const result = await response.json();

      if (result.success) {
        Swal.fire({
          title: 'Success!',
          text: `${selectedLearners.length} students have been assigned to ${selectedClassName}`,
          icon: 'success',
          timer: 3000,
        });
        setSelectedLearners([]);
        setBulkClass('');
        setShowBulkActions(false);
        mutate();
      } else {
        Swal.fire('Error', result.error || 'Failed to assign class.', 'error');
      }
    } catch (error) {
      Swal.fire('Error', 'An unexpected error occurred during bulk assignment.', 'error');
    }
  };

  // Enhanced export with format selection
  const handleExport = async (format: 'excel' | 'csv' = 'excel') => {
    try {
      toast.loading('Preparing export...', {
        duration: 2000,
        position: 'top-right',
        id: 'export-toast'
      });

      // First check if we have data to export
      if (!rows || rows.length === 0) {
        toast.error('No data to export', { id: 'export-toast' });
        return;
      }

      // Create CSV data from current filtered results
      const headers = [
        'Admission Number',
        'First Name',
        'Last Name',
        'Other Name',
        'Gender',
        'Date of Birth',
        'Phone',
        'Email',
        'Address',
        'Class',
        'Stream',
        'Status',
        'Admission Date',
        'District',
        'Village',
        'Attendance %'
      ];

      const csvData = uniqueRows.map(student => [
        generateAdmissionNo(student.id),
        student.first_name || '',
        student.last_name || '',
        student.other_name || '',
        student.gender || '',
        student.date_of_birth || '',
        student.phone || '',
        student.email || '',
        student.address || '',
        student.class_name || '',
        student.stream_name || '',
        student.status || 'active',
        student.admission_date || '',
        student.district_name || '',
        student.village_name || '',
        (student.attendance_percentage || 0).toString()
      ]);

      if (format === 'csv') {
        // Generate CSV
        const csvContent = [headers, ...csvData]
          .map(row => row.map(field => `"${field}"`).join(','))
          .join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        
        const timestamp = new Date().toISOString().split('T')[0];
        link.download = `students_export_${timestamp}.csv`;
        
        document.body.appendChild(link);
        link.click();
        link.remove();
        window.URL.revokeObjectURL(url);
        
        toast.success('CSV file downloaded successfully!', { id: 'export-toast' });
      } else {
        // Try API endpoint for Excel, fallback to CSV if not available
        try {
          const response = await fetch(`${API_BASE}/students/export?format=excel`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data: csvData, headers })
          });

          if (!response.ok) {
            throw new Error('API export failed, using fallback');
          }

          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          
          const timestamp = new Date().toISOString().split('T')[0];
          link.download = `students_export_${timestamp}.xlsx`;
          
          document.body.appendChild(link);
          link.click();
          link.remove();
          window.URL.revokeObjectURL(url);
          
          toast.success('Excel file downloaded successfully!', { id: 'export-toast' });
        } catch (apiError) {
          // Fallback to CSV if Excel API fails
          console.warn('Excel export API failed, falling back to CSV:', apiError);
          await handleExport('csv');
        }
      }
    } catch (error: any) {
      console.error('Export error:', error);
      toast.error(error.message || 'An error occurred during export.', { id: 'export-toast' });
    }
  };

  // Enhanced print function with better formatting
  const handlePrint = async () => {
    try {
      toast.loading('Generating print document...', {
        duration: 3000,
        position: 'top-right',
        id: 'print-toast'
      });

      // Check if we have data to print
      if (!rows || rows.length === 0) {
        toast.error('No data to print', { id: 'print-toast' });
        return;
      }

      const doc = new jsPDF('landscape', 'mm', 'a4');
      
      // Add header
      doc.setFontSize(18);
      doc.setFont('helvetica', 'bold');
      doc.text('DRAIS SCHOOL - STUDENT LIST', 20, 20);
      
      // Add generation date
      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 20, 30);
      doc.text(`Total Students: ${total}`, 20, 35);
      
      // Add filters info if any
      let filterInfo = [];
      if (selectedClass) {
        const className = classOptions.find((cls: any) => cls.id === parseInt(selectedClass))?.name;
        filterInfo.push(`Class: ${className}`);
      }
      if (selectedStream) {
        const streamName = streamOptions.find((stream: any) => stream.id === parseInt(selectedStream))?.name;
        filterInfo.push(`Stream: ${streamName}`);
      }
      if (selectedGender) filterInfo.push(`Gender: ${selectedGender}`);
      if (selectedStatus) filterInfo.push(`Status: ${selectedStatus}`);
      if (query) filterInfo.push(`Search: "${query}"`);
      
      if (filterInfo.length > 0) {
        doc.text(`Filters: ${filterInfo.join(', ')}`, 20, 40);
      }

      // Table headers
      const tableColumnHeaders = [
        'Admission #',
        'Name',
        'Gender',
        'Class',
        'Stream',
        'Status',
        'Phone',
        'Attendance'
      ];

      // Table data - use all filtered data, not just paginated
      const tableRows = uniqueRows.map((row) => [
        generateAdmissionNo(row.id),
        `${row.first_name} ${row.last_name}`,
        row.gender || '-',
        row.class_name || 'No Class',
        row.stream_name || '-',
        row.status || 'active',
        row.phone || '-',
        `${row.attendance_percentage || 0}%`
      ]);

      // Add table using autoTable
      autoTable(doc, {
        head: [tableColumnHeaders],
        body: tableRows,
        startY: filterInfo.length > 0 ? 50 : 45,
        styles: { 
          fontSize: 8,
          cellPadding: 2
        },
        headStyles: {
          fillColor: [59, 130, 246], // Blue color
          textColor: 255,
          fontStyle: 'bold'
        },
        alternateRowStyles: {
          fillColor: [248, 250, 252] // Light gray
        },
        margin: { left: 15, right: 15 },
        tableWidth: 'auto',
        columnStyles: {
          0: { cellWidth: 25 }, // Admission #
          1: { cellWidth: 35 }, // Name
          2: { cellWidth: 15 }, // Gender
          3: { cellWidth: 25 }, // Class
          4: { cellWidth: 25 }, // Stream
          5: { cellWidth: 20 }, // Status
          6: { cellWidth: 25 }, // Phone
          7: { cellWidth: 20 }  // Attendance
        }
      });

      // Add footer
      const pageCount = doc.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.text(`Page ${i} of ${pageCount}`, 280, 200, { align: 'right' });
        doc.text('DRAIS School Management System', 20, 200);
      }

      // Save the PDF
      const pdfBlob = doc.output('blob');
      const url = window.URL.createObjectURL(pdfBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `students_list_${new Date().toISOString().split('T')[0]}.pdf`;
      
      document.body.appendChild(link);
      link.click();
      link.remove();
      window.URL.revokeObjectURL(url);
      
      toast.success('PDF generated and downloaded successfully!', { id: 'print-toast' });
    } catch (error: any) {
      console.error('Print error:', error);
      toast.error('An error occurred while generating the PDF.', { id: 'print-toast' });
    }
  };

  return (
    <div className="space-y-6 p-4 sm:p-6 lg:p-8 gradient-bg min-h-screen">
      {/* Add demo mode banner at the top if in development */}
      {process.env.NODE_ENV !== 'production' && (
        <div className="mb-4 p-3 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg">
          <div className="flex items-center space-x-2">
            <Info className="w-4 h-4 text-amber-600" />
            <p className="text-sm text-amber-800 dark:text-amber-200">
              <strong>Demo Environment:</strong> Fingerprint features are accessible for demonstration. 
              Real biometric capture is enabled but data is stored temporarily.
            </p>
          </div>
        </div>
      )}

      {/* Header Section with enhanced enterprise styling */}
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div className="space-y-1">
          <h1 className="text-2xl sm:text-3xl font-bold bg-gradient-to-r from-gray-900 to-gray-700 dark:from-white dark:to-gray-300 bg-clip-text text-transparent flex items-center gap-3">
            <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-600 to-purple-600 flex items-center justify-center shadow-lg">
              <Users className="w-5 h-5 text-white" />
            </div>
            {t('students.title', 'Students')}
          </h1>
          <p className="text-sm text-gray-600 dark:text-gray-400 flex items-center gap-2">
            <span className="inline-flex items-center gap-1">
              {t('students.total', 'Total')}: 
              <span className="font-semibold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                {total}
              </span> 
              learners
            </span>
            {selectedLearners.length > 0 && (
              <span className="inline-flex items-center gap-1 px-4 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-full text-xs font-medium">
                <CheckSquare className="w-3 h-3" />
                {selectedLearners.length} selected
              </span>
            )}
          </p>
        </div>
        
        <div className="flex flex-wrap items-center gap-2 mobile-stack">
          <button
            onClick={() => {
              setSelectedStudent(null);
              setIsEditing(false);
              setOpen(true);
            }}
            className="btn-primary bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg px-4 py-2 flex items-center gap-2 shadow-md hover:shadow-lg hover:scale-105 transition-transform duration-200 focus:ring-4 focus:ring-indigo-300"
          >
            <Plus className="w-4 h-4" />
            {t('students.add', 'Add Student')}
          </button>

          {selectedLearners.length > 0 && (
            <button
              onClick={() => setShowBulkActions(!showBulkActions)}
              className="btn-accent bg-gradient-to-r from-blue-500 to-teal-500 text-white rounded-lg px-4 py-2 flex items-center gap-2 shadow-md hover:shadow-lg hover:scale-105 transition-transform duration-200 focus:ring-4 focus:ring-blue-300"
            >
              <CheckSquare className="w-4 h-4" />
              Bulk Actions ({selectedLearners.length})
            </button>
          )}

          <button
            onClick={() => setShowBulkPhotoUpload(true)}
            className="btn-secondary bg-gradient-to-r from-gray-700 to-gray-900 text-white rounded-lg px-4 py-2 flex items-center gap-2 shadow-md hover:shadow-lg hover:scale-105 transition-transform duration-200 focus:ring-4 focus:ring-gray-500"
          >
            <Camera className="w-4 h-4" />
            Bulk Photos
          </button>
          
          <button
            onClick={() => setImportOpen(true)}
            className="btn-secondary bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg px-4 py-2 flex items-center gap-2 shadow-md hover:shadow-lg hover:scale-105 transition-transform duration-200 focus:ring-4 focus:ring-green-300"
          >
            <FileUp className="w-4 h-4" />
            {t('common.import', 'Import')}
          </button>
          
          {/* Export Dropdown */}
          <div className="relative group">
            <button
              onClick={() => handleExport('excel')}
              className="btn-secondary bg-gradient-to-r from-yellow-500 to-orange-500 text-white rounded-lg px-4 py-2 flex items-center gap-2 shadow-md hover:shadow-lg hover:scale-105 transition-transform duration-200 focus:ring-4 focus:ring-yellow-300"
            >
              <FileDown className="w-4 h-4" />
              Export
            </button>
            
            {/* Export format dropdown */}
            <div className="absolute right-0 top-full mt-1 w-48 bg-white dark:bg-slate-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-600 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-10">
              <div className="p-2">
                <button
                  onClick={() => handleExport('excel')}
                  className="w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-md flex items-center gap-2"
                >
                  <FileDown className="w-4 h-4" />
                  Export as Excel (.xlsx)
                </button>
                <button
                  onClick={() => handleExport('csv')}
                  className="w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-md flex items-center gap-2"
                >
                  <FileDown className="w-4 h-4" />
                  Export as CSV
                </button>
              </div>
            </div>
          </div>
          
          <button
            onClick={handlePrint}
            className="btn-secondary bg-gradient-to-r from-red-500 to-pink-500 text-white rounded-lg px-4 py-2 flex items-center gap-2 shadow-md hover:shadow-lg hover:scale-105 transition-transform duration-200 focus:ring-4 focus:ring-red-300"
          >
            <Printer className="w-4 h-4" />
            {t('common.print', 'Print')}
          </button>

          <button
            onClick={() => router.push('/attendance')}
            className="btn-accent bg-gradient-to-r from-teal-500 to-cyan-500 text-white rounded-lg px-4 py-2 flex items-center gap-2 shadow-md hover:shadow-lg hover:scale-105 transition-transform duration-200 focus:ring-4 focus:ring-teal-300"
          >
            <UserCheck className="w-4 h-4" />
            Take Attendance
          </button>
        </div>
      </div>

      {/* Bulk Actions Panel */}
      <AnimatePresence>
        {showBulkActions && selectedLearners.length > 0 && (
          <motion.div
            initial={{ height: 0, opacity: 0, y: -10 }}
            animate={{ height: 'auto', opacity: 1, y: 0 }}
            exit={{ height: 0, opacity: 0, y: -10 }}
            transition={{ duration: 0.3, ease: "easeOut" }}
            className="overflow-hidden"
          >
            <div className="card-glass p-6 border-l-4 border-blue-500 dark:border-blue-400 shadow-lg">
              <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                <div className="space-y-1">
                  <h3 className="font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                    <div className="w-5 h-5 rounded bg-blue-500 flex items-center justify-center">
                      <Users className="w-3 h-3 text-white" />
                    </div>
                    Bulk Actions - {selectedLearners.length} students selected
                  </h3>
                  <p className="text-sm text-gray-600 dark:text-gray-400">
                    Assign selected students to a class or perform other bulk operations.
                  </p>
                </div>
                
                <div className="flex items-center gap-3 w-full sm:w-auto">
                  <select
                    value={bulkClass}
                    onChange={(e) => setBulkClass(e.target.value)}
                    className="input-field flex-1 sm:w-48 shadow-sm focus:shadow-md transition-shadow duration-200"
                  >
                    <option value="">Select Class...</option>
                    {classOptions.map((cls: any) => (
                      <option key={`class-${cls.id}`} value={cls.id}>
                        {cls.name}
                      </option>
                    ))}
                  </select>
                  
                  <button
                    onClick={handleBulkAssign}
                    disabled={!bulkClass}
                    className="btn-primary gap-2 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg hover:shadow-xl transition-all duration-200"
                  >
                    <Users className="w-4 h-4" />
                    Assign Class
                  </button>
                  
                  <button
                    onClick={() => {
                      setSelectedLearners([]);
                      setShowBulkActions(false);
                      setBulkClass('');
                    }}
                    className="btn-secondary shadow-lg hover:shadow-xl transition-all duration-200"
                  >
                    Cancel
                  </button>
                </div>
              </div>
            </div>
          </motion.div>
        )}
      </AnimatePresence>

      {/* Enhanced Filters Section */}
      <div className="card-glass p-4 sm:p-6 space-y-4 shadow-lg">
        <div className="flex flex-col sm:flex-row gap-4">
          <div className="flex-1">
            <div className="relative group">
              <Search className={clsx("absolute top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400 group-focus-within:text-blue-500 transition-colors duration-200", isRTL ? "right-3" : "left-3")} />
              <input
                value={query}
                onChange={(e) => {
                  setQuery(e.target.value);
                  setPage(1);
                }}
                placeholder={t('students.search', 'Search by name, ID, or class...')}
                className={clsx("input-field shadow-sm focus:shadow-md transition-all duration-200", isRTL ? "pr-10 pl-4" : "pl-10 pr-4")}
              />
            </div>
          </div>
          
          <button
            onClick={() => setShowFilters(!showFilters)}
            className="btn-secondary gap-2 min-w-fit shadow-lg hover:shadow-xl transition-all duration-200"
          >
            <Filter className="w-4 h-4" />
            Filters
            {(selectedClass || selectedStream || selectedGender || selectedStatus) && (
              <span className="bg-blue-600 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center shadow-inner">
                {[selectedClass, selectedStream, selectedGender, selectedStatus].filter(Boolean).length}
              </span>
            )}
          </button>
        </div>

        {/* Enhanced filter dropdowns with smooth animations */}
        <AnimatePresence>
          {showFilters && (
            <motion.div
              initial={{ height: 0, opacity: 0 }}
              animate={{ height: 'auto', opacity: 1 }}
              exit={{ height: 0, opacity: 0 }}
              transition={{ duration: 0.3 }}
              className="overflow-hidden"
            >
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 pt-4 border-t border-gray-200 dark:border-gray-600">
                {/* Enhanced select inputs with better styling */}
                <select
                  value={selectedClass}
                  onChange={(e) => {
                    setSelectedClass(e.target.value);
                    setPage(1);
                  }}
                  className="input-field shadow-sm focus:shadow-md transition-all duration-200"
                >
                  <option value="">All Classes</option>
                  {classOptions.map((cls: any) => (
                    <option key={`class-${cls.id}`} value={cls.id}>
                      {cls.name}
                    </option>
                  ))}
                </select>

                <select
                  value={selectedStream}
                  onChange={(e) => {
                    setSelectedStream(e.target.value);
                    setPage(1);
                  }}
                  className="input-field shadow-sm focus:shadow-md transition-all duration-200"
                >
                  <option value="">All Streams</option>
                  {streamOptions.map((stream: any) => (
                    <option key={`stream-${stream.id}`} value={stream.id}>
                      {stream.name}
                    </option>
                  ))}
                </select>

                <select
                  value={selectedGender}
                  onChange={(e) => {
                    setSelectedGender(e.target.value);
                    setPage(1);
                  }}
                  className="input-field shadow-sm focus:shadow-md transition-all duration-200"
                >
                  <option value="">All Genders</option>
                  <option value="male">Male</option>
                  <option value="female">Female</option>
                </select>

                <select
                  value={selectedStatus}
                  onChange={(e) => {
                    setSelectedStatus(e.target.value);
                    setPage(1);
                  }}
                  className="input-field shadow-sm focus:shadow-md transition-all duration-200"
                >
                  <option value="">All Status</option>
                  {statusOptions.map((status) => (
                    <option key={`status-${status.value}`} value={status.value}>
                      {status.label}
                    </option>
                  ))}
                </select>
              </div>

              <div className="flex justify-end mt-4">
                <button
                  onClick={clearFilters}
                  className="text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors duration-200 hover:underline"
                >
                  Clear all filters
                </button>
              </div>
            </motion.div>
          )}
        </AnimatePresence>
      </div>

      {/* Enhanced Table Section */}
      <div className="card overflow-hidden shadow-xl">
        {/* Desktop Table with improved styling */}
        <div className="hidden lg:block overflow-x-auto">
          <table className="w-full">
            <thead className="bg-gradient-to-r from-gray-50 to-blue-50 dark:from-slate-700 dark:to-indigo-800/50 border-b border-gray-200 dark:border-gray-600">
              <tr>
                <th className="px-6 py-4 text-start">
                  <button
                    onClick={handleSelectAll}
                    className="flex items-center justify-center w-5 h-5 rounded border-2 border-gray-300 hover:border-blue-500 transition-all duration-200 hover:scale-110"
                  >
                    {selectedLearners.length === paginatedRows.length && paginatedRows.length > 0 ? (
                      <CheckSquare className="w-4 h-4 text-blue-600" />
                    ) : (
                      <Square className="w-4 h-4 text-gray-400" />
                    )}
                  </button>
                </th>
                <th className="px-6 py-4 text-start text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                  Student
                </th>
                <th className="px-6 py-4 text-start text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                  Class & Stream
                </th>
                <th className="px-6 py-4 text-start text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                  Attendance
                </th>
                <th className="px-6 py-4 text-start text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                  Status
                </th>
                <th className="px-6 py-4 text-end text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                  Actions
                </th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-200 dark:divide-gray-600">
              {isLoading && (
                <tr key="loading-row">
                  <td colSpan={6} className="px-6 py-12 text-center">
                    <div className="flex flex-col items-center">
                      <Loader2 className="w-8 h-8 animate-spin text-gradient mb-2" />
                      <span className="text-gray-500 dark:text-gray-400">{t('common.loading')}</span>
                    </div>
                  </td>
                </tr>
              )}
              
              {!isLoading && paginatedRows.length === 0 && (
                <tr key="no-data-row">
                  <td colSpan={6} className="px-6 py-12 text-center">
                    <div className="flex flex-col items-center">
                      <Users className="w-12 h-12 text-gray-300 mb-2" />
                      <span className="text-gray-500 dark:text-gray-400">No students found</span>
                    </div>
                  </td>
                </tr>
              )}
              
              {paginatedRows.map((student) => (
                <motion.tr
                  key={`student-row-${student.id}`}
                  initial={{ opacity: 0, y: 20 }}
                  animate={{ opacity: 1, y: 0 }}
                  transition={{ duration: 0.3 }}
                  className={clsx(
                    "table-row hover:bg-gray-50 dark:hover:bg-slate-700/50 transition-all duration-200",
                    selectedLearners.includes(student.id) && "bg-blue-50 dark:bg-blue-900/20 ring-1 ring-blue-200 dark:ring-blue-700"
                  )}
                >
                  <td className="px-6 py-4">
                    <button
                      onClick={() => handleSelectLearner(student.id)}
                      className="flex items-center justify-center w-5 h-5 rounded border-2 border-gray-300 hover:border-blue-500 transition-all duration-200 hover:scale-110"
                    >
                      {selectedLearners.includes(student.id) ? (
                        <CheckSquare className="w-4 h-4 text-blue-600" />
                      ) : (
                        <Square className="w-4 h-4 text-gray-400" />
                      )}
                    </button>
                  </td>
                  <td className="px-6 py-4">
                    <div className="flex items-center space-x-3">
                      {getStudentAvatar(student)}
                      <div className="flex-1">
                        <div className="text-sm font-medium text-gray-900 dark:text-gray-100">
                          {editingCell?.studentId === student.id && editingCell.field === 'first_name' ? (
                            <div className="flex items-center gap-1 inline-edit-container">
                              <input
                                type="text"
                                value={editingValue}
                                onChange={(e) => setEditingValue(e.target.value)}
                                onBlur={saveInlineEdit}
                                onKeyDown={handleInlineEditKeyDown}
                                className="border-2 border-blue-300 dark:border-blue-600 rounded px-1 py-0.5 text-sm font-medium bg-white dark:bg-slate-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:border-blue-500 dark:focus:border-blue-400 min-w-0 w-auto"
                                autoFocus
                                disabled={isUpdating}
                              />
                              {isUpdating && <Loader2 className="w-4 h-4 animate-spin text-blue-500" />}
                            </div>
                          ) : (
                            <span
                              onClick={() => startInlineEdit(student.id, 'first_name', student.first_name)}
                              className="cursor-pointer hover:bg-gray-100 dark:hover:bg-slate-600 rounded px-1 py-0.5 transition-colors"
                              title="Click to edit first name"
                            >
                              {student.first_name}
                            </span>
                          )}
                          {' '}
                          {editingCell?.studentId === student.id && editingCell.field === 'last_name' ? (
                            <div className="flex items-center gap-1 inline-edit-container">
                              <input
                                type="text"
                                value={editingValue}
                                onChange={(e) => setEditingValue(e.target.value)}
                                onBlur={saveInlineEdit}
                                onKeyDown={handleInlineEditKeyDown}
                                className="border-2 border-blue-300 dark:border-blue-600 rounded px-1 py-0.5 text-sm font-medium bg-white dark:bg-slate-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:border-blue-500 dark:focus:border-blue-400 min-w-0 w-auto"
                                autoFocus
                                disabled={isUpdating}
                              />
                              {isUpdating && <Loader2 className="w-4 h-4 animate-spin text-blue-500" />}
                            </div>
                          ) : (
                            <span
                              onClick={() => startInlineEdit(student.id, 'last_name', student.last_name)}
                              className="cursor-pointer hover:bg-gray-100 dark:hover:bg-slate-600 rounded px-1 py-0.5 transition-colors"
                              title="Click to edit last name"
                            >
                              {student.last_name}
                            </span>
                          )}
                        </div>
                        <div className="text-xs text-gray-500 dark:text-gray-400 font-mono">
                          {generateAdmissionNo(student.id)}
                        </div>
                      </div>

                      {/* New: small inline Edit Photo button */}
                      <button
                        onClick={() => openPhotoEditor(student)}
                        className="ml-3 p-1.5 rounded-md bg-white/70 dark:bg-slate-700 hover:shadow-md border border-gray-200 dark:border-slate-600 text-gray-600 dark:text-gray-200 transition"
                        title="Edit photo"
                      >
                        <Camera className="w-4 h-4" />
                      </button>
                    </div>
                  </td>
                  <td className="px-6 py-4">
                    <div className="text-sm text-gray-900 dark:text-gray-100">
                      {student.class_name || 'No Class'}
                    </div>
                    {student.stream_name && (
                      <div className="text-xs text-gray-500 dark:text-gray-400">
                        {student.stream_name}
                      </div>
                    )}
                  </td>
                  <td className="px-6 py-4">
                    <div className="flex items-center space-x-2">
                      <div className="text-sm font-medium text-gray-900 dark:text-gray-100">
                        {student.attendance_percentage || 0}%
                      </div>
                      <div className="w-16 bg-gray-200 rounded-full h-2">
                        <div 
                          className={clsx(
                            "h-2 rounded-full",
                            (student.attendance_percentage || 0) >= 85 ? "bg-green-500" :
                            (student.attendance_percentage || 0) >= 75 ? "bg-yellow-500" : "bg-red-500"
                          )}
                          style={{ width: `${student.attendance_percentage || 0}%` }}
                        />
                      </div>
                    </div>
                  </td>
                  <td className="px-6 py-4">
                    <div className="relative">
                      <select
                        value={student.status || ''}
                        onChange={(e) => {
                          const newStatus = e.target.value as Student['status'] | '';
                          if (!newStatus) return;
                          // Intercept for suspend/expel so we can collect details and generate letter
                          if (newStatus === 'on_leave' || newStatus === 'suspended' || newStatus === 'expelled') {
                            // map legacy 'on_leave' -> suspend flow if desired; here treat 'suspended' explicitly
                            if (newStatus === 'suspended' || newStatus === 'on_leave') {
                              setStatusAction('suspend');
                            } else if (newStatus === 'expelled') {
                              setStatusAction('expel');
                            } 
                            setStatusTargetStudent(student);
                            setStatusModalOpen(true);
                            return;
                          }
                          // default flow for other statuses
                          handleStatusChange(student, newStatus as Student['status']);
                        }}
                        className="appearance-none bg-transparent border-0 text-xs font-medium focus:ring-0 cursor-pointer"
                      >
                        <option value="">{t('students.select_status', 'Select status...')}</option>
                        {statusOptions.map((option) => (
                          <option key={`status-option-${option.value}`} value={option.value}>
                            {option.label}
                          </option>
                        ))}
                      </select>
                      {getStatusBadge(student.status)}
                    </div>
                  </td>
                  <td className="px-6 py-4 text-end">
                    <div className="flex items-center justify-end space-x-2 rtl:space-x-reverse">
                      <button
                        onClick={() => handleViewDetails(student)}
                        className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-all dark:hover:bg-blue-900/20"
                        title="View Details"
                      >
                        <Eye className="w-4 h-4" />
                      </button>
                      {getFingerprintButton(student)}
                      <button
                        onClick={() => handleEdit(student)}
                        className="p-2 text-gray-400 hover:text-orange-600 hover:bg-orange-50 rounded-lg transition-all dark:hover:bg-orange-900/20"
                        title="Edit"
                      >
                        <Edit className="w-4 h-4" />
                      </button>
                      <button
                        onClick={() => handleDelete(student)}
                        className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all dark:hover:bg-red-900/20"
                        title="Delete"
                      >
                        <Trash className="w-4 h-4" />
                      </button>
                    </div>
                  </td>
                </motion.tr>
              ))}
            </tbody>
          </table>
        </div>

        {/* Enhanced Mobile Cards */}
        <div className="lg:hidden space-y-4 p-4">
          {isLoading && (
            <div key="mobile-loading" className="flex flex-col items-center py-12">
              <Loader2 className="w-8 h-8 animate-spin text-gradient mb-2" />
              <span className="text-gray-500 dark:text-gray-400">{t('common.loading')}</span>
            </div>
          )}
          
          {!isLoading && paginatedRows.length === 0 && (
            <div key="mobile-no-data" className="text-center py-12">
              <Users className="w-12 h-12 text-gray-300 mb-2 mx-auto" />
              <span className="text-gray-500 dark:text-gray-400">No students found</span>
            </div>
          )}
          
          {paginatedRows.map((student) => (
            <motion.div
              key={`mobile-student-${student.id}`}
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.3 }}
              className={clsx(
                "card-glass p-4 space-y-3 shadow-lg hover:shadow-xl transition-all duration-300",
                selectedLearners.includes(student.id) && "ring-2 ring-blue-500 bg-blue-50 dark:bg-blue-900/20"
              )}
            >
              <div className="flex items-center justify-between">
                <div className="flex items-center space-x-3 rtl:space-x-reverse">
                  <button
                    onClick={() => handleSelectLearner(student.id)}
                    className="flex items-center justify-center w-5 h-5 rounded border-2 border-gray-300 hover:border-blue-500 transition-all duration-200 hover:scale-110"
                  >
                    {selectedLearners.includes(student.id) ? (
                      <CheckSquare className="w-4 h-4 text-blue-600" />
                    ) : (
                      <Square className="w-4 h-4 text-gray-400" />
                    )}
                  </button>
                  {getStudentAvatarLarge(student)}
                  <div className="flex-1">
                    <h3 className="font-semibold text-gray-900 dark:text-gray-100">
                      {editingCell?.studentId === student.id && editingCell.field === 'first_name' ? (
                        <div className="flex items-center gap-1 inline-edit-container">
                          <input
                            type="text"
                            value={editingValue}
                            onChange={(e) => setEditingValue(e.target.value)}
                            onBlur={saveInlineEdit}
                            onKeyDown={handleInlineEditKeyDown}
                            className="border-2 border-blue-300 dark:border-blue-600 rounded px-1 py-0.5 text-sm font-semibold bg-white dark:bg-slate-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:border-blue-500 dark:focus:border-blue-400 min-w-0 w-auto"
                            autoFocus
                            disabled={isUpdating}
                          />
                          {isUpdating && <Loader2 className="w-4 h-4 animate-spin text-blue-500" />}
                        </div>
                      ) : (
                        <span
                          onClick={() => startInlineEdit(student.id, 'first_name', student.first_name)}
                          className="cursor-pointer hover:bg-gray-100 dark:hover:bg-slate-600 rounded px-1 py-0.5 transition-colors"
                          title="Click to edit first name"
                        >
                          {student.first_name}
                        </span>
                      )}
                      {' '}
                      {editingCell?.studentId === student.id && editingCell.field === 'last_name' ? (
                        <div className="flex items-center gap-1 inline-edit-container">
                          <input
                            type="text"
                            value={editingValue}
                            onChange={(e) => setEditingValue(e.target.value)}
                            onBlur={saveInlineEdit}
                            onKeyDown={handleInlineEditKeyDown}
                            className="border-2 border-blue-300 dark:border-blue-600 rounded px-1 py-0.5 text-sm font-semibold bg-white dark:bg-slate-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:border-blue-500 dark:focus:border-blue-400 min-w-0 w-auto"
                            autoFocus
                            disabled={isUpdating}
                          />
                          {isUpdating && <Loader2 className="w-4 h-4 animate-spin text-blue-500" />}
                        </div>
                      ) : (
                        <span
                          onClick={() => startInlineEdit(student.id, 'last_name', student.last_name)}
                          className="cursor-pointer hover:bg-gray-100 dark:hover:bg-slate-600 rounded px-1 py-0.5 transition-colors"
                          title="Click to edit last name"
                        >
                          {student.last_name}
                        </span>
                      )}
                    </h3>
                    <p className="text-sm text-gray-500 dark:text-gray-400 font-mono">
                      {generateAdmissionNo(student.id)}
                    </p>
                  </div>
                </div>
                
                {getStatusBadge(student.status)}
              </div>
              
              <div className="grid grid-cols-2 gap-4 text-sm">
                <div>
                  <span className="font-medium text-gray-600 dark:text-gray-400">Class:</span>
                  <div className="text-gray-900 dark:text-gray-100">
                    {student.class_name || 'No Class'}
                  </div>
                </div>
                <div>
                  <span className="font-medium text-gray-600 dark:text-gray-400">Attendance:</span>
                  <div className="flex items-center space-x-2">
                    <span className="text-gray-900 dark:text-gray-100">
                      {student.attendance_percentage || 0}%
                    </span>
                    <div className="flex-1 bg-gray-200 rounded-full h-2">
                      <div 
                        className={clsx(
                          "h-2 rounded-full",
                          (student.attendance_percentage || 0) >= 85 ? "bg-green-500" :
                          (student.attendance_percentage || 0) >= 75 ? "bg-yellow-500" : "bg-red-500"
                        )}
                        style={{ width: `${student.attendance_percentage || 0}%` }}
                      />
                    </div>
                  </div>
                </div>
              </div>
              
              <div className="flex items-center justify-between pt-2 border-t border-gray-200 dark:border-gray-600">
                <div className="flex space-x-2 rtl:space-x-reverse">
                  <button
                    onClick={() => handleViewDetails(student)}
                    className="p-2 rounded-lg bg-gray-100 dark:bg-slate-600 text-gray-600 dark:text-gray-300 hover:bg-blue-100 hover:text-blue-600 dark:hover:bg-blue-900/20 transition-all"
                  >
                    <Eye className="w-4 h-4" />
                  </button>
                  {getFingerprintButton(student, true)}
                  <button
                    onClick={() => handleEdit(student)}
                    className="p-2 rounded-lg bg-gray-100 dark:bg-slate-600 text-gray-600 dark:text-gray-300 hover:bg-orange-100 hover:text-orange-600 dark:hover:bg-orange-900/20 transition-all"
                  >
                    <Edit className="w-4 h-4" />
                  </button>
                </div>
                
                <select
                  value={student.status || ''}
                  onChange={(e) => {
                    const newStatus = e.target.value as Student['status'] | '';
                    if (!newStatus) return;
                    // Intercept for suspend/expel so we can collect details and generate letter
                    if (newStatus === 'on_leave' || newStatus === 'suspended' || newStatus === 'expelled') {
                      // map legacy 'on_leave' -> suspend flow if desired; here treat 'suspended' explicitly
                      if (newStatus === 'suspended' || newStatus === 'on_leave') {
                        setStatusAction('suspend');
                      } else if (newStatus === 'expelled') {
                        setStatusAction('expel');
                      } 
                      setStatusTargetStudent(student);
                      setStatusModalOpen(true);
                      return;
                    }
                    // default flow for other statuses
                    handleStatusChange(student, newStatus as Student['status']);
                  }}
                  className="appearance-none bg-transparent border-0 text-xs font-medium focus:ring-0 cursor-pointer"
                >
                  <option value="">{t('students.select_status', 'Select status...')}</option>
                  {statusOptions.map((option) => (
                    <option key={`status-option-${option.value}`} value={option.value}>
                      {option.label}
                    </option>
                  ))}
                </select>
              </div>
            </motion.div>
          ))}
        </div>
      </div>

      {/* Add Pagination Component */}
      {!isLoading && total > 0 && (
        <div className="flex justify-center">
          <Pagination
            currentPage={page}
            totalPages={pages}
            onPageChange={setPage}
            totalItems={total}
            itemsPerPage={rowsPerPage}
          />
        </div>
      )}

      {/* Student Details Modal */}
      <LearnerDetailsModal
        open={detailsOpen}
        onClose={() => setDetailsOpen(false)}
        learner={selectedLearner}
        onRefresh={mutate}
      />

      {/* Student Edit Modal */}
      <EditStudentWizard
        open={editOpen}
        onClose={() => setEditOpen(false)}
        student={selectedStudent}
        onSubmit={handleSubmit}
      />

      {/* Student Add Modal */}
      <StudentWizard
        open={open}
        onClose={() => setOpen(false)}
        onCreated={() => {
          mutate(); // Refresh the data
        }}
        onSubmit={async (formData) => {
          // Auto-assign class and stream based on selected options
          if (bulkClass) {
            formData.class_id = bulkClass;
            formData.stream_id = selectedStream;
          }
          
          await handleSubmit(formData);
        }}
      />

      {/* Import Modal */}
      <ImportModal
        open={importOpen}
        onClose={() => setImportOpen(false)}
        onImportSuccess={() => {
          setImportOpen(false);
          mutate(); // Refresh the data
          toast.success('Students imported successfully!');
        }}
      />

      {/* Bulk Photo Upload Modal */}
      <BulkPhotoUploadModal
        open={showBulkPhotoUpload}
        onClose={() => setShowBulkPhotoUpload(false)}
        students={rows || []} // Ensure we pass an array
        onUploadComplete={() => {
          setShowBulkPhotoUpload(false);
          mutate();
        }}
      />

      {/* Status Action Modal */}
      <StatusActionModal
        open={statusModalOpen}
        onClose={() => setStatusModalOpen(false)}
        student={statusTargetStudent}
        action={statusAction}
        onConfirm={async (reason?) => {
          if (statusAction === 'suspend' && reason) {
            // Enhanced suspend flow with reason and letter generation
            const letterResponse = await fetch('/api/letters/generate-suspension', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ student_id: statusTargetStudent?.id, reason }),
            });
            
            const letterResult = await letterResponse.json();
            
            if (letterResult.success) {
              // Auto-download the generated letter
              const pdfUrl = letterResult.data.url;
              const link = document.createElement('a');
              link.href = pdfUrl;
              link.download = `Suspension_Letter_${statusTargetStudent?.id}.pdf`;
              link.click();
              
              toast.success('Suspension letter generated and downloaded!', { duration: 4000 });
            } else {
              toast.error('Failed to generate suspension letter.', { duration: 4000 });
            }
          }
          
          handleStatusChange(statusTargetStudent!, statusAction === 'expel' ? 'expelled' : 'suspended');
        }}
        onCancel={() => setStatusModalOpen(false)}
      />

      {/* Fingerprint Modal */}
      <FingerprintModal
        open={fingerprintModalOpen}
        onClose={() => {
          setFingerprintModalOpen(false);
          setFingerprintStudent(null);
        }}
        student={fingerprintStudent}
        onFingerprintCaptured={(studentId, hasFingerprint) => {
          // Update local status immediately
          setFingerprintStatuses(prev => ({
            ...prev,
            [studentId]: { hasFingerprint, loading: false, lastFetched: Date.now() }
          }));
          
          // Dispatch custom event for other components
          window.dispatchEvent(new CustomEvent('fingerprintStatusChanged', {
            detail: { studentId, hasFingerprint }
          }));
          
          // Refresh data
          mutate();
        }}
      />

      {/* Photo Editor Modal */}
      <PhotoEditorModal
        open={photoEditorOpen}
        onClose={() => setPhotoEditorOpen(false)}
        student={photoEditorStudent}
        onSave={async (photoUrl) => {
          if (selectedLearner) {
            // Optimistically update the local state
          }
          
          mutate();
        }}
      />
    </div>
  );
};

export default StudentTable;
